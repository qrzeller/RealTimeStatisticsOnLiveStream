%
% File: chap01.tex
% Author: Zeller Quentin
% Description: Introduction
%
%\let\textcircled=\pgftextcircled
\chapter{Wowza}
\label{chap:Wowza}
\section{Wowza transcoder and overlay}
\label{sec:sec04a}
\initial{W}owza est un serveur de distribution multimédia. Il permet aussi de transcoder les flux vidéo cependant les utilisateurs du services semblent préférer à l'heure actuelle la librairie FFmpeg pour une bonne partie des transcodage, Wowza ne supportant que l'encodage en H.264, VP8 et VP9.
Pour ce qui est du projet, Wowza possède une API de transcodage comportant certaines fonction d'overlays. Leur documentation propose un module exemple qui ajoute du texte dans un flux transcodé par Wowza. Contrairement a la facilité d'implémentation des overlays OpenCV, ici nous nous retrouvons avec plus d'un millier de lignes de code. Cette implémentation propose deux endroit où ajouter les overlays. La première est lors du décodage. Cette méthode à l'avantage d'être plus performante car les transformations sont ajoutée une seule fois à la lecture du flux. Suivant le format, il se peux que le rendu soit détérioré lors de la mise a l'échelle et l'encodage du flux. La deuxième méthode consiste à modifier la vidéo lors de l'encodage. Elle dispose d'un rendu de meilleur qualité car les overlays ajouté sont de la même résolution que le flux sortant. Il faudra cependant beaucoup plus de ressources pour traiter les vidéos si plusieurs flux de sorties sont paramétrés. Il est possible aussi d'avoir des overlays différents suivant les types ou résolutions de flux de sortie.\cite{wowza}

Le test du serveur Wowza à été fait avec la version développer de Wowza, donc la licence est disponible pendant 6 mois.
\begin{itemize}
	\item Language : Java 8
	\item OS : Windows 10
	\item technologie cartes graphiques : Nvidia Cuda + Intel iGPU
	\item Architecture : Intel x86, i7-6700
	\item Version : Wowza 4.7
	\item Visionneuse : VLC
\end{itemize}
\  \\

Le code ci-dessous est un extrait de la classe Java OverlayImage du module exemple, disponible sur le site même de Wowza \footnote{https://www.wowza.com/downloads/forums/transcoderoverlayexamplefiles/TranscoderOverlayExampleFiles.zip}. Cette fonction est appelée sur chaque image présente dans le buffer. Nous remarquons à la ligne 11 qu'il a été décidé d'utiliser la classe Graphics2D standard de Java pour retoucher les images. Cette granularité nous permet de retoucher le flux de la même manière qu'avec OpenCV mais cette fois-ci en utilisant les outils Java standard.



Dans la section suivante \ref{sec:sec04c}, nous profiterons pour expliquer comment installer des modules dans le serveur Wowza.



\definecolor{javared}{rgb}{0.6,0,0} % for strings
\definecolor{javagreen}{rgb}{0.25,0.5,0.35} % comments
\definecolor{javapurple}{rgb}{0.5,0,0.35} % keywords
\definecolor{javadocblue}{rgb}{0.25,0.35,0.75} % javadoc

\lstset{language=Java,
	basicstyle=\ttfamily,
	keywordstyle=\color{javapurple}\bfseries,
	stringstyle=\color{javared},
	commentstyle=\color{javagreen},
	morecomment=[s][\color{javadocblue}]{/**}{*/},
	numbers=left,
	numberstyle=\tiny\color{black},
	numbersep=10pt,
	tabsize=4,
	showspaces=false,
	showstringspaces=false}

\lstinputlisting[language=Java, firstline=216, lastline=261, caption={Extrait du code d'ajout d'overlay officiel de Wowza. Lignes: 216-261\cite{wowza} \label{wowza-transcoder-code}}]{../../app/wowza_overlay/src/OverlayImage.java}

%=======


\section{Clamp - Module Streamtoolbox.com}
\label{sec:sec04c}

Clamp est un module transcoder de Wowza du même type que celui montré plus haut. Il permet l'ajout d'overlays sur tout flux vidéo transcodé ar Wowza. Il est développé par Streamtoolbox.com qui est une compagnie développant des outils de retouche vidéo à la volée et de statistiques pour Wowza. Toute leurs solutions son payantes. La solution qui nous intéresse, Clamp, a un prix unique de 300\$ par serveur.\cite{streamtoolbox}
Nous profitons de la présentation de ce module pour montrer comment celui-ci est installé sur le serveur, car elle n'est pas forcément très évidente de prime abord.

Dans la pratique, ce module se place entre le décodage et l'encodage comme le fait le module de la \autoref{sec:sec04a}. Il instancie un serveur HTTP qui permet non seulement l'utilisation de l'API RESTful via des POST mais aussi celle de l'interface graphique permettant de générer "à la souris" les requêtes REST (voir \autoref{fig:w8}). Beaucoup de paramètres sont disponibles dont trois fonctions principales, l'ajout de texte, l'ajout d'image, l'ajout de dates. Cette api possède également des fonctions de transition et d'ombres pour les objets.

Pour streamer le flux vidéo dans le serveur Wowza, nous avons utiliser le logiciel OBS (Open Broadcaster) qui permet de transcoder des flux vidéo de multiples sources vers un serveur multimédia. D'autres méthode simple sont possible, dont l'utilisation de VLC.

Installation :
\begin{itemize}
	\item Dans les services Windows, après l'installation de Wowza, lancer le service Wowza Streaming Engine ainsi que Wowza Streaming Engine Manager.
	\item Se rendre sur la page Web port 8088 et configurer ce qui est demandé.
	\item Dans l'onglet application, créer une nouvelle "live application" et lui donner un nom.
	\item La configuration du serveur Wowza nécessite l'édition du fichier module \url{C:/Program Files (x86)/Wowza Media Systems/Wowza Streaming Engine 4.7.4/conf/nom-app} dans le dossier correspondant au nom de l'application.
	\item Éditer le fichier de la \autoref{fig:w11} et de la \autoref{fig:w12}. Nous noterons l'ajout de l'objet XML Module qui permet d'instancier Clamp dans la live application. Puis son paramétrage en \autoref{fig:w12}. "Clamp.caption.source.file" permet de spécifier un fichier au lieu de l'interface REST, nous pouvons également spécifier le port et d'autres paramètres comme la calibration qui ajoute une grille de test par dessus la vidéo. Le détails de ses paramètres est spécifié dans la documentation Clamp.
	\item Finalement, il faut ajouter le code du module Clamp sous la forme d'un .jar dans le dossier "/lib/" de Wowza.
	\item A des fin de debugging il peut être intéressant de lancer le fichier "startup.bat" se trouvant dans le dossier "/bin/" de Wowza. Celui-ci nous permet de voir la sortie standard de l'application et les éventuelles erreurs d'exécution.
\end{itemize}


\begin{figure}[h]
	\centering
	\includegraphics[width=1\linewidth]{fig01/capture6}
	\mycaption[Wowza - Flowchart appareils]{Workflow Wowza - Flowchart\label{fig:w6}}
\end{figure}
\begin{figure}
	\centering
\includegraphics[width=1\linewidth]{fig01/capture7}
	\mycaption[Wowza génération du flux d'entrée avec OBS.]{Génération du flux d'entrée de Wowza avec OBS, Open Broadcaster.\label{fig:w7}}
\end{figure}
\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{fig01/capture8}
	\mycaption[Paramétrage du module Wowza Clamp.]{Paramétrage et test du module Wowza Clamp.\label{fig:w8}}
\end{figure}



\begin{figure}[h]
	\centering
	\includegraphics[width=0.5\linewidth]{fig01/capture10}
	\mycaption[Wowza - Affichage non supporté.]{Affichage non supporté - Interface test.\label{fig:w10}}
\end{figure}
\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{fig01/capture11}
	\mycaption[Paramétrage du module pour Wowza serveur.]{Paramétrage du module pour Wowza serveur.\label{fig:w11}}
\end{figure}
\begin{figure}
	\centering
	\includegraphics[width=1\linewidth]{fig01/capture12}
	\mycaption[Paramétrage du module pour Wowza serveur.]{Paramétrage du module pour Wowza serveur.\label{fig:w12}}
\end{figure}
	
	
Bien qu'en aillant suivit les recommandation du développeur quand a l'installation du module. Lors du visionnage du flux de données, les modifications ne semblent pas être prises en compte. Le problème viendrait du fait que le flux n'est pas transcodé, et que donc les overlays ne peuvent être inséré dans celui-ci. Les lecteurs test inséré dans l'interface graphique de Wowza semblent confirmer cette thèse, ils ne fonctionnent tout simplement pas ( voir \autoref{fig:w10} ). Le module de transcodage Wowza est assez récent et est différent de celui présenté sur le site constructeur de Clamp. Il n'est donc pas possible de suivre leurs recommandation. Dans tout les cas, il n'est pas normal qu'aucun message d'erreur ne soit transmis. Que ce soit au niveau de l'interface graphique de Clamp, de Wowza et même au niveau de la console qui affirme prendre en compte les nouveaux overlays et les ajouter.
	


%=========================================================